#ifdef FU_RENDERER_TYPE_VK09090
#include "core/logger.h"

#include "misc.inner.h"
//
//  default shader
//  clang-format off

//
//  Shader

static void t_shader_attr_free(TShaderAttrNode* attr)
{
    TShaderAttrNode* curr = attr;
    while (curr) {
        attr = curr->next;
        fu_free(curr);
        curr = attr;
    }
}

static void t_shader_binding_free(TShaderBindNode* binding)
{
    TShaderBindNode* curr = binding;
    while (curr) {
        binding = curr->next;
        fu_free(curr);
        curr = binding;
    }
}

void t_shader_desc_free(TShaderDescNode* desc)
{
    TShaderDescNode* curr = desc;
    while (curr) {
        if (curr->destroy)
            curr->destroy(curr->data);
        desc = curr->next;
        fu_free(curr);
        curr = desc;
    }
}

static TShaderArgs* t_shader_args_new_default()
{
    TShaderArgs* sda = (TShaderArgs*)fu_malloc0(sizeof(TShaderArgs));
    sda->info.sType = VK_STRUCTURE_TYPE_SHADER_MODULE_CREATE_INFO;
    sda->filter = VK_FILTER_LINEAR;
    sda->mipmapMode = VK_SAMPLER_MIPMAP_MODE_LINEAR;
    sda->addressMode = VK_SAMPLER_ADDRESS_MODE_REPEAT;
    return sda;
}
typedef TShaderArgs* (*TShaderArgsInitDefaultFunc)(TShaderArgs* sda);
TShaderArgs* t_shader_args_init_default_ubo_vert(TShaderArgs* sda)
{
    const uint32_t shader_22_ubo_vert[] = {
        0x07230203, 0x00010600, 0x0008000b, 0x00000031, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
        0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
        0x000a000f, 0x00000000, 0x00000004, 0x6e69616d, 0x00000000, 0x0000000d, 0x00000013, 0x00000021,
        0x0000002d, 0x0000002f, 0x00030003, 0x00000002, 0x000001c2, 0x00040005, 0x00000004, 0x6e69616d,
        0x00000000, 0x00060005, 0x0000000b, 0x505f6c67, 0x65567265, 0x78657472, 0x00000000, 0x00060006,
        0x0000000b, 0x00000000, 0x505f6c67, 0x7469736f, 0x006e6f69, 0x00070006, 0x0000000b, 0x00000001,
        0x505f6c67, 0x746e696f, 0x657a6953, 0x00000000, 0x00070006, 0x0000000b, 0x00000002, 0x435f6c67,
        0x4470696c, 0x61747369, 0x0065636e, 0x00070006, 0x0000000b, 0x00000003, 0x435f6c67, 0x446c6c75,
        0x61747369, 0x0065636e, 0x00030005, 0x0000000d, 0x00000000, 0x00070005, 0x00000011, 0x66696e55,
        0x426d726f, 0x65666675, 0x6a624f72, 0x00746365, 0x00050006, 0x00000011, 0x00000000, 0x65646f6d,
        0x0000006c, 0x00050006, 0x00000011, 0x00000001, 0x77656976, 0x00000000, 0x00050006, 0x00000011,
        0x00000002, 0x6a6f7270, 0x00000000, 0x00030005, 0x00000013, 0x006f6275, 0x00050005, 0x00000021,
        0x6f506e69, 0x69746973, 0x00006e6f, 0x00050005, 0x0000002d, 0x67617266, 0x6f6c6f43, 0x00000072,
        0x00040005, 0x0000002f, 0x6f436e69, 0x00726f6c, 0x00050048, 0x0000000b, 0x00000000, 0x0000000b,
        0x00000000, 0x00050048, 0x0000000b, 0x00000001, 0x0000000b, 0x00000001, 0x00050048, 0x0000000b,
        0x00000002, 0x0000000b, 0x00000003, 0x00050048, 0x0000000b, 0x00000003, 0x0000000b, 0x00000004,
        0x00030047, 0x0000000b, 0x00000002, 0x00040048, 0x00000011, 0x00000000, 0x00000005, 0x00050048,
        0x00000011, 0x00000000, 0x00000023, 0x00000000, 0x00050048, 0x00000011, 0x00000000, 0x00000007,
        0x00000010, 0x00040048, 0x00000011, 0x00000001, 0x00000005, 0x00050048, 0x00000011, 0x00000001,
        0x00000023, 0x00000040, 0x00050048, 0x00000011, 0x00000001, 0x00000007, 0x00000010, 0x00040048,
        0x00000011, 0x00000002, 0x00000005, 0x00050048, 0x00000011, 0x00000002, 0x00000023, 0x00000080,
        0x00050048, 0x00000011, 0x00000002, 0x00000007, 0x00000010, 0x00030047, 0x00000011, 0x00000002,
        0x00040047, 0x00000013, 0x00000022, 0x00000000, 0x00040047, 0x00000013, 0x00000021, 0x00000000,
        0x00040047, 0x00000021, 0x0000001e, 0x00000000, 0x00040047, 0x0000002d, 0x0000001e, 0x00000000,
        0x00040047, 0x0000002f, 0x0000001e, 0x00000001, 0x00020013, 0x00000002, 0x00030021, 0x00000003,
        0x00000002, 0x00030016, 0x00000006, 0x00000020, 0x00040017, 0x00000007, 0x00000006, 0x00000004,
        0x00040015, 0x00000008, 0x00000020, 0x00000000, 0x0004002b, 0x00000008, 0x00000009, 0x00000001,
        0x0004001c, 0x0000000a, 0x00000006, 0x00000009, 0x0006001e, 0x0000000b, 0x00000007, 0x00000006,
        0x0000000a, 0x0000000a, 0x00040020, 0x0000000c, 0x00000003, 0x0000000b, 0x0004003b, 0x0000000c,
        0x0000000d, 0x00000003, 0x00040015, 0x0000000e, 0x00000020, 0x00000001, 0x0004002b, 0x0000000e,
        0x0000000f, 0x00000000, 0x00040018, 0x00000010, 0x00000007, 0x00000004, 0x0005001e, 0x00000011,
        0x00000010, 0x00000010, 0x00000010, 0x00040020, 0x00000012, 0x00000002, 0x00000011, 0x0004003b,
        0x00000012, 0x00000013, 0x00000002, 0x0004002b, 0x0000000e, 0x00000014, 0x00000002, 0x00040020,
        0x00000015, 0x00000002, 0x00000010, 0x0004002b, 0x0000000e, 0x00000018, 0x00000001, 0x00040017,
        0x0000001f, 0x00000006, 0x00000002, 0x00040020, 0x00000020, 0x00000001, 0x0000001f, 0x0004003b,
        0x00000020, 0x00000021, 0x00000001, 0x0004002b, 0x00000006, 0x00000023, 0x00000000, 0x0004002b,
        0x00000006, 0x00000024, 0x3f800000, 0x00040020, 0x00000029, 0x00000003, 0x00000007, 0x00040017,
        0x0000002b, 0x00000006, 0x00000003, 0x00040020, 0x0000002c, 0x00000003, 0x0000002b, 0x0004003b,
        0x0000002c, 0x0000002d, 0x00000003, 0x00040020, 0x0000002e, 0x00000001, 0x0000002b, 0x0004003b,
        0x0000002e, 0x0000002f, 0x00000001, 0x00050036, 0x00000002, 0x00000004, 0x00000000, 0x00000003,
        0x000200f8, 0x00000005, 0x00050041, 0x00000015, 0x00000016, 0x00000013, 0x00000014, 0x0004003d,
        0x00000010, 0x00000017, 0x00000016, 0x00050041, 0x00000015, 0x00000019, 0x00000013, 0x00000018,
        0x0004003d, 0x00000010, 0x0000001a, 0x00000019, 0x00050092, 0x00000010, 0x0000001b, 0x00000017,
        0x0000001a, 0x00050041, 0x00000015, 0x0000001c, 0x00000013, 0x0000000f, 0x0004003d, 0x00000010,
        0x0000001d, 0x0000001c, 0x00050092, 0x00000010, 0x0000001e, 0x0000001b, 0x0000001d, 0x0004003d,
        0x0000001f, 0x00000022, 0x00000021, 0x00050051, 0x00000006, 0x00000025, 0x00000022, 0x00000000,
        0x00050051, 0x00000006, 0x00000026, 0x00000022, 0x00000001, 0x00070050, 0x00000007, 0x00000027,
        0x00000025, 0x00000026, 0x00000023, 0x00000024, 0x00050091, 0x00000007, 0x00000028, 0x0000001e,
        0x00000027, 0x00050041, 0x00000029, 0x0000002a, 0x0000000d, 0x0000000f, 0x0003003e, 0x0000002a,
        0x00000028, 0x0004003d, 0x0000002b, 0x00000030, 0x0000002f, 0x0003003e, 0x0000002d, 0x00000030,
        0x000100fd, 0x00010038
    };
    fu_free(sda->code);
    sda->code = fu_memdup(shader_22_ubo_vert, sizeof(shader_22_ubo_vert));
    sda->info.pCode = sda->code;
    sda->info.codeSize = sizeof(shader_22_ubo_vert);
    sda->stage = VK_SHADER_STAGE_VERTEX_BIT;
    sda->flags |= E_SHADER_ARGS_FLAG_DEFAULT_WITH_UBO;
    return sda;
}

TShaderArgs* t_shader_args_init_default_ubo_frag(TShaderArgs* sda)
{
    const uint32_t shader_22_ubo_frag[] = {
        0x07230203, 0x00010600, 0x0008000b, 0x00000013, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
        0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
        0x0007000f, 0x00000004, 0x00000004, 0x6e69616d, 0x00000000, 0x00000009, 0x0000000c, 0x00030010,
        0x00000004, 0x00000007, 0x00030003, 0x00000002, 0x000001c2, 0x00040005, 0x00000004, 0x6e69616d,
        0x00000000, 0x00050005, 0x00000009, 0x4374756f, 0x726f6c6f, 0x00000000, 0x00050005, 0x0000000c,
        0x67617266, 0x6f6c6f43, 0x00000072, 0x00040047, 0x00000009, 0x0000001e, 0x00000000, 0x00040047,
        0x0000000c, 0x0000001e, 0x00000000, 0x00020013, 0x00000002, 0x00030021, 0x00000003, 0x00000002,
        0x00030016, 0x00000006, 0x00000020, 0x00040017, 0x00000007, 0x00000006, 0x00000004, 0x00040020,
        0x00000008, 0x00000003, 0x00000007, 0x0004003b, 0x00000008, 0x00000009, 0x00000003, 0x00040017,
        0x0000000a, 0x00000006, 0x00000003, 0x00040020, 0x0000000b, 0x00000001, 0x0000000a, 0x0004003b,
        0x0000000b, 0x0000000c, 0x00000001, 0x0004002b, 0x00000006, 0x0000000e, 0x3f800000, 0x00050036,
        0x00000002, 0x00000004, 0x00000000, 0x00000003, 0x000200f8, 0x00000005, 0x0004003d, 0x0000000a,
        0x0000000d, 0x0000000c, 0x00050051, 0x00000006, 0x0000000f, 0x0000000d, 0x00000000, 0x00050051,
        0x00000006, 0x00000010, 0x0000000d, 0x00000001, 0x00050051, 0x00000006, 0x00000011, 0x0000000d,
        0x00000002, 0x00070050, 0x00000007, 0x00000012, 0x0000000f, 0x00000010, 0x00000011, 0x0000000e,
        0x0003003e, 0x00000009, 0x00000012, 0x000100fd, 0x00010038
    };
    fu_free(sda->code);
    sda->code = fu_memdup(shader_22_ubo_frag, sizeof(shader_22_ubo_frag));
    sda->info.pCode = sda->code;
    sda->info.codeSize = sizeof(shader_22_ubo_frag);
    sda->stage = VK_SHADER_STAGE_FRAGMENT_BIT;
    sda->flags |= E_SHADER_ARGS_FLAG_DEFAULT_WITH_UBO;
    return sda;
}

TShaderArgs* t_shader_args_init_default_texture_vert(TShaderArgs* sda)
{
    const uint32_t shader_32_texture_vert[] = {
        0x07230203, 0x00010600, 0x0008000b, 0x00000035, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
        0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
        0x000c000f, 0x00000000, 0x00000004, 0x6e69616d, 0x00000000, 0x0000000d, 0x00000013, 0x00000021,
        0x0000002d, 0x0000002f, 0x00000032, 0x00000033, 0x00030003, 0x00000002, 0x000001c2, 0x00040005,
        0x00000004, 0x6e69616d, 0x00000000, 0x00060005, 0x0000000b, 0x505f6c67, 0x65567265, 0x78657472,
        0x00000000, 0x00060006, 0x0000000b, 0x00000000, 0x505f6c67, 0x7469736f, 0x006e6f69, 0x00070006,
        0x0000000b, 0x00000001, 0x505f6c67, 0x746e696f, 0x657a6953, 0x00000000, 0x00070006, 0x0000000b,
        0x00000002, 0x435f6c67, 0x4470696c, 0x61747369, 0x0065636e, 0x00070006, 0x0000000b, 0x00000003,
        0x435f6c67, 0x446c6c75, 0x61747369, 0x0065636e, 0x00030005, 0x0000000d, 0x00000000, 0x00070005,
        0x00000011, 0x66696e55, 0x426d726f, 0x65666675, 0x6a624f72, 0x00746365, 0x00050006, 0x00000011,
        0x00000000, 0x65646f6d, 0x0000006c, 0x00050006, 0x00000011, 0x00000001, 0x77656976, 0x00000000,
        0x00050006, 0x00000011, 0x00000002, 0x6a6f7270, 0x00000000, 0x00030005, 0x00000013, 0x006f6275,
        0x00050005, 0x00000021, 0x6f506e69, 0x69746973, 0x00006e6f, 0x00050005, 0x0000002d, 0x67617266,
        0x6f6c6f43, 0x00000072, 0x00040005, 0x0000002f, 0x6f436e69, 0x00726f6c, 0x00060005, 0x00000032,
        0x67617266, 0x43786554, 0x64726f6f, 0x00000000, 0x00050005, 0x00000033, 0x65546e69, 0x6f6f4378,
        0x00006472, 0x00050048, 0x0000000b, 0x00000000, 0x0000000b, 0x00000000, 0x00050048, 0x0000000b,
        0x00000001, 0x0000000b, 0x00000001, 0x00050048, 0x0000000b, 0x00000002, 0x0000000b, 0x00000003,
        0x00050048, 0x0000000b, 0x00000003, 0x0000000b, 0x00000004, 0x00030047, 0x0000000b, 0x00000002,
        0x00040048, 0x00000011, 0x00000000, 0x00000005, 0x00050048, 0x00000011, 0x00000000, 0x00000023,
        0x00000000, 0x00050048, 0x00000011, 0x00000000, 0x00000007, 0x00000010, 0x00040048, 0x00000011,
        0x00000001, 0x00000005, 0x00050048, 0x00000011, 0x00000001, 0x00000023, 0x00000040, 0x00050048,
        0x00000011, 0x00000001, 0x00000007, 0x00000010, 0x00040048, 0x00000011, 0x00000002, 0x00000005,
        0x00050048, 0x00000011, 0x00000002, 0x00000023, 0x00000080, 0x00050048, 0x00000011, 0x00000002,
        0x00000007, 0x00000010, 0x00030047, 0x00000011, 0x00000002, 0x00040047, 0x00000013, 0x00000022,
        0x00000000, 0x00040047, 0x00000013, 0x00000021, 0x00000000, 0x00040047, 0x00000021, 0x0000001e,
        0x00000000, 0x00040047, 0x0000002d, 0x0000001e, 0x00000000, 0x00040047, 0x0000002f, 0x0000001e,
        0x00000001, 0x00040047, 0x00000032, 0x0000001e, 0x00000001, 0x00040047, 0x00000033, 0x0000001e,
        0x00000002, 0x00020013, 0x00000002, 0x00030021, 0x00000003, 0x00000002, 0x00030016, 0x00000006,
        0x00000020, 0x00040017, 0x00000007, 0x00000006, 0x00000004, 0x00040015, 0x00000008, 0x00000020,
        0x00000000, 0x0004002b, 0x00000008, 0x00000009, 0x00000001, 0x0004001c, 0x0000000a, 0x00000006,
        0x00000009, 0x0006001e, 0x0000000b, 0x00000007, 0x00000006, 0x0000000a, 0x0000000a, 0x00040020,
        0x0000000c, 0x00000003, 0x0000000b, 0x0004003b, 0x0000000c, 0x0000000d, 0x00000003, 0x00040015,
        0x0000000e, 0x00000020, 0x00000001, 0x0004002b, 0x0000000e, 0x0000000f, 0x00000000, 0x00040018,
        0x00000010, 0x00000007, 0x00000004, 0x0005001e, 0x00000011, 0x00000010, 0x00000010, 0x00000010,
        0x00040020, 0x00000012, 0x00000002, 0x00000011, 0x0004003b, 0x00000012, 0x00000013, 0x00000002,
        0x0004002b, 0x0000000e, 0x00000014, 0x00000002, 0x00040020, 0x00000015, 0x00000002, 0x00000010,
        0x0004002b, 0x0000000e, 0x00000018, 0x00000001, 0x00040017, 0x0000001f, 0x00000006, 0x00000002,
        0x00040020, 0x00000020, 0x00000001, 0x0000001f, 0x0004003b, 0x00000020, 0x00000021, 0x00000001,
        0x0004002b, 0x00000006, 0x00000023, 0x00000000, 0x0004002b, 0x00000006, 0x00000024, 0x3f800000,
        0x00040020, 0x00000029, 0x00000003, 0x00000007, 0x00040017, 0x0000002b, 0x00000006, 0x00000003,
        0x00040020, 0x0000002c, 0x00000003, 0x0000002b, 0x0004003b, 0x0000002c, 0x0000002d, 0x00000003,
        0x00040020, 0x0000002e, 0x00000001, 0x0000002b, 0x0004003b, 0x0000002e, 0x0000002f, 0x00000001,
        0x00040020, 0x00000031, 0x00000003, 0x0000001f, 0x0004003b, 0x00000031, 0x00000032, 0x00000003,
        0x0004003b, 0x00000020, 0x00000033, 0x00000001, 0x00050036, 0x00000002, 0x00000004, 0x00000000,
        0x00000003, 0x000200f8, 0x00000005, 0x00050041, 0x00000015, 0x00000016, 0x00000013, 0x00000014,
        0x0004003d, 0x00000010, 0x00000017, 0x00000016, 0x00050041, 0x00000015, 0x00000019, 0x00000013,
        0x00000018, 0x0004003d, 0x00000010, 0x0000001a, 0x00000019, 0x00050092, 0x00000010, 0x0000001b,
        0x00000017, 0x0000001a, 0x00050041, 0x00000015, 0x0000001c, 0x00000013, 0x0000000f, 0x0004003d,
        0x00000010, 0x0000001d, 0x0000001c, 0x00050092, 0x00000010, 0x0000001e, 0x0000001b, 0x0000001d,
        0x0004003d, 0x0000001f, 0x00000022, 0x00000021, 0x00050051, 0x00000006, 0x00000025, 0x00000022,
        0x00000000, 0x00050051, 0x00000006, 0x00000026, 0x00000022, 0x00000001, 0x00070050, 0x00000007,
        0x00000027, 0x00000025, 0x00000026, 0x00000023, 0x00000024, 0x00050091, 0x00000007, 0x00000028,
        0x0000001e, 0x00000027, 0x00050041, 0x00000029, 0x0000002a, 0x0000000d, 0x0000000f, 0x0003003e,
        0x0000002a, 0x00000028, 0x0004003d, 0x0000002b, 0x00000030, 0x0000002f, 0x0003003e, 0x0000002d,
        0x00000030, 0x0004003d, 0x0000001f, 0x00000034, 0x00000033, 0x0003003e, 0x00000032, 0x00000034,
        0x000100fd, 0x00010038
    };
    fu_free(sda->code);
    sda->code = fu_memdup(shader_32_texture_vert, sizeof(shader_32_texture_vert));
    sda->info.pCode = sda->code;
    sda->info.codeSize = sizeof(shader_32_texture_vert);
    sda->stage = VK_SHADER_STAGE_VERTEX_BIT;
    sda->flags |= E_SHADER_ARGS_FLAG_DEFAULT_WITH_TEXTURE;
    return sda;
}

TShaderArgs* t_shader_args_init_default_texture_frag(TShaderArgs* sda)
{
    const uint32_t shader_32_texture_frag[] = {
        0x07230203, 0x00010600, 0x0008000b, 0x00000017, 0x00000000, 0x00020011, 0x00000001, 0x0006000b,
        0x00000001, 0x4c534c47, 0x6474732e, 0x3035342e, 0x00000000, 0x0003000e, 0x00000000, 0x00000001,
        0x0009000f, 0x00000004, 0x00000004, 0x6e69616d, 0x00000000, 0x00000009, 0x0000000d, 0x00000011,
        0x00000016, 0x00030010, 0x00000004, 0x00000007, 0x00030003, 0x00000002, 0x000001c2, 0x00040005,
        0x00000004, 0x6e69616d, 0x00000000, 0x00050005, 0x00000009, 0x4374756f, 0x726f6c6f, 0x00000000,
        0x00050005, 0x0000000d, 0x53786574, 0x6c706d61, 0x00007265, 0x00060005, 0x00000011, 0x67617266,
        0x43786554, 0x64726f6f, 0x00000000, 0x00050005, 0x00000016, 0x67617266, 0x6f6c6f43, 0x00000072,
        0x00040047, 0x00000009, 0x0000001e, 0x00000000, 0x00040047, 0x0000000d, 0x00000022, 0x00000000,
        0x00040047, 0x0000000d, 0x00000021, 0x00000001, 0x00040047, 0x00000011, 0x0000001e, 0x00000001,
        0x00040047, 0x00000016, 0x0000001e, 0x00000000, 0x00020013, 0x00000002, 0x00030021, 0x00000003,
        0x00000002, 0x00030016, 0x00000006, 0x00000020, 0x00040017, 0x00000007, 0x00000006, 0x00000004,
        0x00040020, 0x00000008, 0x00000003, 0x00000007, 0x0004003b, 0x00000008, 0x00000009, 0x00000003,
        0x00090019, 0x0000000a, 0x00000006, 0x00000001, 0x00000000, 0x00000000, 0x00000000, 0x00000001,
        0x00000000, 0x0003001b, 0x0000000b, 0x0000000a, 0x00040020, 0x0000000c, 0x00000000, 0x0000000b,
        0x0004003b, 0x0000000c, 0x0000000d, 0x00000000, 0x00040017, 0x0000000f, 0x00000006, 0x00000002,
        0x00040020, 0x00000010, 0x00000001, 0x0000000f, 0x0004003b, 0x00000010, 0x00000011, 0x00000001,
        0x00040017, 0x00000014, 0x00000006, 0x00000003, 0x00040020, 0x00000015, 0x00000001, 0x00000014,
        0x0004003b, 0x00000015, 0x00000016, 0x00000001, 0x00050036, 0x00000002, 0x00000004, 0x00000000,
        0x00000003, 0x000200f8, 0x00000005, 0x0004003d, 0x0000000b, 0x0000000e, 0x0000000d, 0x0004003d,
        0x0000000f, 0x00000012, 0x00000011, 0x00050057, 0x00000007, 0x00000013, 0x0000000e, 0x00000012,
        0x0003003e, 0x00000009, 0x00000013, 0x000100fd, 0x00010038
    };
    fu_free(sda->code);
    sda->code = fu_memdup(shader_32_texture_frag, sizeof(shader_32_texture_frag));
    sda->info.pCode = sda->code;
    sda->info.codeSize = sizeof(shader_32_texture_frag);
    sda->stage = VK_SHADER_STAGE_FRAGMENT_BIT;
    sda->flags |= E_SHADER_ARGS_FLAG_DEFAULT_WITH_TEXTURE;
    return sda;
}

static TShaderArgs* t_shader_args_new(const FUShaderCode* code, VkShaderStageFlagBits stage)
{
    fu_return_val_if_fail(code && stage, NULL);
    fu_return_val_if_fail(code->code && code->size, NULL);
    TShaderArgs* sda = t_shader_args_new_default();
    sda->code = fu_memdup(code->code, code->size);
    sda->info.pCode = sda->code;
    sda->info.codeSize = code->size;
    sda->stage = stage;
    return sda;
}

void t_shader_args_free(TShaderArgs* args)
{
    if (!args)
        return;
    fu_free(args->code);
    fu_free(args);
}

void t_shader_args_free_all(TShaderArgs* args)
{
    TShaderArgs* curr = args;
    while (curr) {
        args = curr->next;

        t_shader_attr_free(curr->attr);
        t_shader_desc_free(curr->desc);
        t_shader_binding_free(curr->bind);
        t_shader_args_free(curr);
        curr = args;
    }
}

FU_DEFINE_TYPE(FUShader, fu_shader, FU_TYPE_OBJECT)

static void fu_shader_dispose(FUObject* obj)
{
    FUShader* sd = (FUShader*)obj;
    t_shader_args_free(sd->args);
    fu_free(sd->name);
}

static void fu_shader_class_init(FUObjectClass* oc)
{
    oc->dispose = fu_shader_dispose;
}

FUShader* fu_shader_new(const char* name, const FUShaderCode* source, VkShaderStageFlagBits stage)
{
    fu_return_val_if_fail(source && source->code && source->size, NULL);
    FUShader* sd = (FUShader*)fu_object_new(FU_TYPE_SHADER);
    sd->args = t_shader_args_new(source, stage);
    sd->name = fu_strdup(name);
    sd->stage = stage;

    return sd;
}

FUShader* fu_shader_new_default(const char* name, VkShaderStageFlagBits stage)
{
    static const TShaderArgsInitDefaultFunc fns[] = {
        [VK_SHADER_STAGE_VERTEX_BIT] = t_shader_args_init_default_ubo_vert,
        [VK_SHADER_STAGE_FRAGMENT_BIT] = t_shader_args_init_default_ubo_frag
    };
    fu_return_val_if_fail(fns[stage], NULL);
    FUShader* sd = (FUShader*)fu_object_new(FU_TYPE_SHADER);
    sd->args = fns[stage](t_shader_args_new_default());
    sd->name = fu_strdup(name);
    sd->stage = stage;
    return sd;
}

/**
 * @brief 释放链表形态的着色器
 * 内部使用
 * @param shader
 */
void fu_shader_unref_all(FUShader* shader)
{
    FUShader* curr = shader;
    while (curr) {
        shader = curr->next;
        fu_object_unref(curr);
        curr = shader;
    }
}

void fu_shader_add_attributes(FUShader* shader, const uint32_t cnt, ...)
{
    static const uint32_t defAttrSizes[] = {
        [VK_FORMAT_R32_SINT] = sizeof(int32_t),
        [VK_FORMAT_R32G32_SINT] = sizeof(int32_t[2]),
        [VK_FORMAT_R32G32B32_SINT] = sizeof(int32_t[3]),
        [VK_FORMAT_R32G32B32A32_SINT] = sizeof(int32_t[4]),
        [VK_FORMAT_R32_UINT] = sizeof(uint32_t),
        [VK_FORMAT_R32G32_UINT] = sizeof(uint32_t[2]),
        [VK_FORMAT_R32G32B32_UINT] = sizeof(uint32_t[3]),
        [VK_FORMAT_R32G32B32A32_UINT] = sizeof(uint32_t[4]),
        [VK_FORMAT_R64_SINT] = sizeof(int64_t),
        [VK_FORMAT_R64G64_SINT] = sizeof(int64_t[2]),
        [VK_FORMAT_R64G64B64_SINT] = sizeof(int64_t[3]),
        [VK_FORMAT_R64G64B64A64_SINT] = sizeof(int64_t[4]),
        [VK_FORMAT_R64_UINT] = sizeof(uint64_t),
        [VK_FORMAT_R64G64_UINT] = sizeof(uint64_t[2]),
        [VK_FORMAT_R64G64B64_UINT] = sizeof(uint64_t[3]),
        [VK_FORMAT_R64G64B64A64_UINT] = sizeof(uint64_t[4]),
        [VK_FORMAT_R32_SFLOAT] = sizeof(float),
        [VK_FORMAT_R32G32_SFLOAT] = sizeof(float[2]),
        [VK_FORMAT_R32G32B32_SFLOAT] = sizeof(float[3]),
        [VK_FORMAT_R32G32B32A32_SFLOAT] = sizeof(float[4]),
        [VK_FORMAT_R64_SFLOAT] = sizeof(double),
        [VK_FORMAT_R64G64_SFLOAT] = sizeof(double[2]),
        [VK_FORMAT_R64G64B64_SFLOAT] = sizeof(double[3]),
        [VK_FORMAT_R64G64B64A64_SFLOAT] = sizeof(double[4])
    };
    fu_return_if_fail(shader && shader->args && cnt);
    fu_return_if_true(VK_SHADER_STAGE_VERTEX_BIT != shader->args->stage);
    TShaderAttrNode *prev = shader->args->attr, *curr;
    va_list args;
    va_start(args, cnt);

    for (uint32_t i = 0; i < cnt; i++) {
        curr = (TShaderAttrNode*)fu_malloc0(sizeof(TShaderAttrNode));
        curr->format = va_arg(args, VkFormat);
        curr->size = defAttrSizes[curr->format];
        curr->next = prev;
        prev = curr;
        if (curr->next) {
            curr->idx = curr->next->idx + 1;
            curr->offset = curr->next->offset + curr->next->size;
        }
        // fu_return_if_true(shader->args->size < curr->offset + curr->size);
    }
    va_end(args);
    shader->args->attr = curr;
    if (shader->args->flags)
        shader->args = t_shader_args_init_default_ubo_vert(shader->args);
}

static TShaderDescNode* _shader_add_descriptor_uniform(FUShader* shader, const uint32_t size, void* data, FUNotify destroy)
{
    fu_return_val_if_fail(VK_SHADER_STAGE_FRAGMENT_BIT != shader->args->stage, NULL);
    TShaderDescNode* desc = (TShaderDescNode*)fu_malloc0(sizeof(TShaderDescNode));
    desc->descriptor.descriptorType = VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER;
    desc->dataSize = size;
    desc->data = data;
    if (destroy) {
        desc->data = fu_memdup(data, size);
        desc->destroy = destroy;
    }
    if (shader->args->flags)
        shader->args = t_shader_args_init_default_ubo_vert(shader->args);
    return desc;
}

static TShaderDescNode* _shader_add_descriptor_image_path(FUShader* shader, const char* path)
{
    fu_return_val_if_true(VK_SHADER_STAGE_FRAGMENT_BIT != shader->args->stage, NULL);
    int channels;
    TShaderDescNode* desc = (TShaderDescNode*)fu_malloc0(sizeof(TShaderDescNode));
    desc->data = stbi_load(path, (int*)&desc->imgSize.width, (int*)&desc->imgSize.height, &channels, STBI_rgb_alpha);
    if (FU_UNLIKELY(!desc->data)) {
        fu_error("Failed to load image: %s\n", path);
        fu_free(desc);
        return NULL;
    }
    if (shader->args->flags)
        shader->args = t_shader_args_init_default_texture_frag(shader->args);
    desc->descriptor.descriptorType = VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER;
    desc->destroy = stbi_image_free;
    return desc;
}

/**
 * @brief 添加统一描述符。按照目标着色器和数据大小识别不同类型
 * 1. 如果目标着色器是顶点着色器,则描述符类型为 VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER
 * 2. 如果目标着色器是片段着色器,则描述符类型为 VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER
 *  并且：2.1 如果 size == 0，表示 data 为图片路径
 *       2.2 如果 size != 0，表示 data 为纹理数据
 */
void fu_shader_add_descriptor(FUShader* shader, const uint32_t count, const uint32_t size, void* data, FUNotify destroy)
{
    fu_return_if_fail(shader && shader->args && count);
    TShaderDescNode* desc = NULL;

    if (VK_SHADER_STAGE_FRAGMENT_BIT != shader->args->stage)
        desc = _shader_add_descriptor_uniform(shader, size, data, destroy);
    else if (!size)
        desc = _shader_add_descriptor_image_path(shader, (char*)data);
    if (FU_UNLIKELY(!desc))
        return;
    desc->cnt = 1;
    if (shader->args->desc) {
        desc->next = shader->args->desc;
        desc->idx = desc->next->cnt;
        desc->cnt = desc->idx + 1;
        desc->descriptor.binding = desc->idx;
    }
    shader->args->desc = desc;
    desc->descriptor.stageFlags = shader->args->stage;
    desc->descriptor.descriptorCount = count;
}

static void fu_shader_free_attributes(FUShader* shader)
{
    fu_return_if_fail(shader && shader->args);
    TShaderAttrNode* attr = shader->args->attr;
    while (attr) {
        shader->args->attr = attr->next;
        fu_free(attr);
        attr = shader->args->attr;
    }
}

static void fu_shader_free_bindings(FUShader* shader)
{
    fu_return_if_fail(shader && shader->args);
    TShaderBindNode* bind = shader->args->bind;
    while (bind) {
        shader->args->bind = bind->next;
        fu_free(bind);
        bind = shader->args->bind;
    }
}

static void fu_shader_free_descriptors(FUShader* shader)
{
    fu_return_if_fail(shader && shader->args);
    TShaderDescNode* desc = shader->args->desc;
    while (desc) {
        shader->args->desc = desc->next;
        if (desc->destroy)
            desc->destroy(desc->data);
        fu_free(desc);
        desc = shader->args->desc;
    }
}

void fu_shader_update_sampler(FUShader* shader, VkFilter filter, VkSamplerMipmapMode mipmapMode, VkSamplerAddressMode addressMode)
{
    fu_return_if_fail(shader && shader->args);
    shader->args->filter = filter;
    shader->args->mipmapMode = mipmapMode;
    shader->args->addressMode = addressMode;
}

VkVertexInputAttributeDescription* t_shader_submit_attributes(FUShader* shader, uint32_t* cnt)
{
    fu_return_val_if_fail(shader && shader->args && cnt, NULL);
    fu_return_val_if_fail(shader->args->attr, NULL);
    TShaderAttrNode* attr = shader->args->attr;
    *cnt = attr->idx + 1;
    VkVertexInputAttributeDescription* rev = (VkVertexInputAttributeDescription*)fu_malloc0(sizeof(VkVertexInputAttributeDescription) * (*cnt));
    shader->size = attr->offset + attr->size;
    while (attr) {
        rev[attr->idx].location = attr->idx;
        rev[attr->idx].offset = attr->offset;
        rev[attr->idx].format = attr->format;

        attr = attr->next;
    }
    fu_shader_free_attributes(shader);
    return rev;
}

TShaderDescNode* t_shader_descriptor_link_and_steal(FUShader* shader, TShaderDescNode* prev)
{
    fu_return_val_if_fail(shader && shader->args, NULL);
    if (!shader->args->desc)
        return prev;
    TShaderDescNode* rev = fu_steal_pointer(&shader->args->desc);
    if (prev) {
        TShaderDescNode* curr = rev;
        do {
            curr->descriptor.binding += prev->descriptor.binding + 1;
            if (!curr->next)
                break;
            curr = curr->next;
        } while (true);
        curr->next = prev;
        rev->cnt += prev->cnt;
    }
    return rev;
}

VkDescriptorSetLayoutBinding* t_shader_descriptors_to_binding(TShaderDescNode* desc)
{
    fu_return_val_if_fail(desc, NULL);
    VkDescriptorSetLayoutBinding* rev = (VkDescriptorSetLayoutBinding*)fu_malloc0(sizeof(VkDescriptorSetLayoutBinding) * desc->cnt);
    uint32_t idx = 0;
    do {
        desc->descriptor.binding = idx++;
        memcpy(&rev[desc->descriptor.binding], &desc->descriptor, sizeof(VkDescriptorSetLayoutBinding));
        desc = desc->next;
    } while (desc);
    return rev;
}

VkDescriptorPoolSize* t_shader_descriptors_fill_sizes(TShaderDescNode* desc, VkDescriptorPoolSize* sizes)
{
    fu_return_val_if_fail(desc && sizes, sizes);
    while (desc) {
        sizes[desc->descriptor.binding].type = desc->descriptor.descriptorType;
        sizes[desc->descriptor.binding].descriptorCount = desc->descriptor.descriptorCount;
        desc = desc->next;
    }
    return sizes;
}

TShaderArgs* t_shader_args_link_and_steal(FUShader* shader, TShaderArgs* prev)
{
    fu_return_val_if_fail(shader && shader->args, prev);

    TShaderArgs* args = fu_steal_pointer(&shader->args);

    if (prev) {
        args->next = prev;
        args->idx = prev->idx + 1;
    }
    return args;
}

FUShader* fu_shader_link_and_steal(FUShader** curr, FUShader** next)
{
    fu_return_val_if_fail(curr && next, NULL);
    fu_print_func_name();
    FUShader* rev = fu_steal_pointer(curr);
    rev->next = fu_steal_pointer(next);
    if (rev->next)
        rev->idx = rev->idx + 1;
    return rev;
}

//
// shader library

// static FUShaderCode* _defShaders = NULL;
// static uint32_t _defShaderCnt = 0;

// void fu_shader_library_init() {
//     // clang-format off
// static const uint32_t shader_32_texture_vert[] = {
// 	0x07230203,0x00010600,0x0008000b,0x00000035,0x00000000,0x00020011,0x00000001,0x0006000b,
// 	0x00000001,0x4c534c47,0x6474732e,0x3035342e,0x00000000,0x0003000e,0x00000000,0x00000001,
// 	0x000c000f,0x00000000,0x00000004,0x6e69616d,0x00000000,0x0000000d,0x00000013,0x00000021,
// 	0x0000002d,0x0000002f,0x00000032,0x00000033,0x00030003,0x00000002,0x000001c2,0x00040005,
// 	0x00000004,0x6e69616d,0x00000000,0x00060005,0x0000000b,0x505f6c67,0x65567265,0x78657472,
// 	0x00000000,0x00060006,0x0000000b,0x00000000,0x505f6c67,0x7469736f,0x006e6f69,0x00070006,
// 	0x0000000b,0x00000001,0x505f6c67,0x746e696f,0x657a6953,0x00000000,0x00070006,0x0000000b,
// 	0x00000002,0x435f6c67,0x4470696c,0x61747369,0x0065636e,0x00070006,0x0000000b,0x00000003,
// 	0x435f6c67,0x446c6c75,0x61747369,0x0065636e,0x00030005,0x0000000d,0x00000000,0x00070005,
// 	0x00000011,0x66696e55,0x426d726f,0x65666675,0x6a624f72,0x00746365,0x00050006,0x00000011,
// 	0x00000000,0x65646f6d,0x0000006c,0x00050006,0x00000011,0x00000001,0x77656976,0x00000000,
// 	0x00050006,0x00000011,0x00000002,0x6a6f7270,0x00000000,0x00030005,0x00000013,0x006f6275,
// 	0x00050005,0x00000021,0x6f506e69,0x69746973,0x00006e6f,0x00050005,0x0000002d,0x67617266,
// 	0x6f6c6f43,0x00000072,0x00040005,0x0000002f,0x6f436e69,0x00726f6c,0x00060005,0x00000032,
// 	0x67617266,0x43786554,0x64726f6f,0x00000000,0x00050005,0x00000033,0x65546e69,0x6f6f4378,
// 	0x00006472,0x00050048,0x0000000b,0x00000000,0x0000000b,0x00000000,0x00050048,0x0000000b,
// 	0x00000001,0x0000000b,0x00000001,0x00050048,0x0000000b,0x00000002,0x0000000b,0x00000003,
// 	0x00050048,0x0000000b,0x00000003,0x0000000b,0x00000004,0x00030047,0x0000000b,0x00000002,
// 	0x00040048,0x00000011,0x00000000,0x00000005,0x00050048,0x00000011,0x00000000,0x00000023,
// 	0x00000000,0x00050048,0x00000011,0x00000000,0x00000007,0x00000010,0x00040048,0x00000011,
// 	0x00000001,0x00000005,0x00050048,0x00000011,0x00000001,0x00000023,0x00000040,0x00050048,
// 	0x00000011,0x00000001,0x00000007,0x00000010,0x00040048,0x00000011,0x00000002,0x00000005,
// 	0x00050048,0x00000011,0x00000002,0x00000023,0x00000080,0x00050048,0x00000011,0x00000002,
// 	0x00000007,0x00000010,0x00030047,0x00000011,0x00000002,0x00040047,0x00000013,0x00000022,
// 	0x00000000,0x00040047,0x00000013,0x00000021,0x00000000,0x00040047,0x00000021,0x0000001e,
// 	0x00000000,0x00040047,0x0000002d,0x0000001e,0x00000000,0x00040047,0x0000002f,0x0000001e,
// 	0x00000001,0x00040047,0x00000032,0x0000001e,0x00000001,0x00040047,0x00000033,0x0000001e,
// 	0x00000002,0x00020013,0x00000002,0x00030021,0x00000003,0x00000002,0x00030016,0x00000006,
// 	0x00000020,0x00040017,0x00000007,0x00000006,0x00000004,0x00040015,0x00000008,0x00000020,
// 	0x00000000,0x0004002b,0x00000008,0x00000009,0x00000001,0x0004001c,0x0000000a,0x00000006,
// 	0x00000009,0x0006001e,0x0000000b,0x00000007,0x00000006,0x0000000a,0x0000000a,0x00040020,
// 	0x0000000c,0x00000003,0x0000000b,0x0004003b,0x0000000c,0x0000000d,0x00000003,0x00040015,
// 	0x0000000e,0x00000020,0x00000001,0x0004002b,0x0000000e,0x0000000f,0x00000000,0x00040018,
// 	0x00000010,0x00000007,0x00000004,0x0005001e,0x00000011,0x00000010,0x00000010,0x00000010,
// 	0x00040020,0x00000012,0x00000002,0x00000011,0x0004003b,0x00000012,0x00000013,0x00000002,
// 	0x0004002b,0x0000000e,0x00000014,0x00000002,0x00040020,0x00000015,0x00000002,0x00000010,
// 	0x0004002b,0x0000000e,0x00000018,0x00000001,0x00040017,0x0000001f,0x00000006,0x00000002,
// 	0x00040020,0x00000020,0x00000001,0x0000001f,0x0004003b,0x00000020,0x00000021,0x00000001,
// 	0x0004002b,0x00000006,0x00000023,0x00000000,0x0004002b,0x00000006,0x00000024,0x3f800000,
// 	0x00040020,0x00000029,0x00000003,0x00000007,0x00040017,0x0000002b,0x00000006,0x00000003,
// 	0x00040020,0x0000002c,0x00000003,0x0000002b,0x0004003b,0x0000002c,0x0000002d,0x00000003,
// 	0x00040020,0x0000002e,0x00000001,0x0000002b,0x0004003b,0x0000002e,0x0000002f,0x00000001,
// 	0x00040020,0x00000031,0x00000003,0x0000001f,0x0004003b,0x00000031,0x00000032,0x00000003,
// 	0x0004003b,0x00000020,0x00000033,0x00000001,0x00050036,0x00000002,0x00000004,0x00000000,
// 	0x00000003,0x000200f8,0x00000005,0x00050041,0x00000015,0x00000016,0x00000013,0x00000014,
// 	0x0004003d,0x00000010,0x00000017,0x00000016,0x00050041,0x00000015,0x00000019,0x00000013,
// 	0x00000018,0x0004003d,0x00000010,0x0000001a,0x00000019,0x00050092,0x00000010,0x0000001b,
// 	0x00000017,0x0000001a,0x00050041,0x00000015,0x0000001c,0x00000013,0x0000000f,0x0004003d,
// 	0x00000010,0x0000001d,0x0000001c,0x00050092,0x00000010,0x0000001e,0x0000001b,0x0000001d,
// 	0x0004003d,0x0000001f,0x00000022,0x00000021,0x00050051,0x00000006,0x00000025,0x00000022,
// 	0x00000000,0x00050051,0x00000006,0x00000026,0x00000022,0x00000001,0x00070050,0x00000007,
// 	0x00000027,0x00000025,0x00000026,0x00000023,0x00000024,0x00050091,0x00000007,0x00000028,
// 	0x0000001e,0x00000027,0x00050041,0x00000029,0x0000002a,0x0000000d,0x0000000f,0x0003003e,
// 	0x0000002a,0x00000028,0x0004003d,0x0000002b,0x00000030,0x0000002f,0x0003003e,0x0000002d,
// 	0x00000030,0x0004003d,0x0000001f,0x00000034,0x00000033,0x0003003e,0x00000032,0x00000034,
// 	0x000100fd,0x00010038
// };
// static const uint32_t shader_32_texture_frag[] = {
// 	0x07230203,0x00010600,0x0008000b,0x00000017,0x00000000,0x00020011,0x00000001,0x0006000b,
// 	0x00000001,0x4c534c47,0x6474732e,0x3035342e,0x00000000,0x0003000e,0x00000000,0x00000001,
// 	0x0009000f,0x00000004,0x00000004,0x6e69616d,0x00000000,0x00000009,0x0000000d,0x00000011,
// 	0x00000016,0x00030010,0x00000004,0x00000007,0x00030003,0x00000002,0x000001c2,0x00040005,
// 	0x00000004,0x6e69616d,0x00000000,0x00050005,0x00000009,0x4374756f,0x726f6c6f,0x00000000,
// 	0x00050005,0x0000000d,0x53786574,0x6c706d61,0x00007265,0x00060005,0x00000011,0x67617266,
// 	0x43786554,0x64726f6f,0x00000000,0x00050005,0x00000016,0x67617266,0x6f6c6f43,0x00000072,
// 	0x00040047,0x00000009,0x0000001e,0x00000000,0x00040047,0x0000000d,0x00000022,0x00000000,
// 	0x00040047,0x0000000d,0x00000021,0x00000001,0x00040047,0x00000011,0x0000001e,0x00000001,
// 	0x00040047,0x00000016,0x0000001e,0x00000000,0x00020013,0x00000002,0x00030021,0x00000003,
// 	0x00000002,0x00030016,0x00000006,0x00000020,0x00040017,0x00000007,0x00000006,0x00000004,
// 	0x00040020,0x00000008,0x00000003,0x00000007,0x0004003b,0x00000008,0x00000009,0x00000003,
// 	0x00090019,0x0000000a,0x00000006,0x00000001,0x00000000,0x00000000,0x00000000,0x00000001,
// 	0x00000000,0x0003001b,0x0000000b,0x0000000a,0x00040020,0x0000000c,0x00000000,0x0000000b,
// 	0x0004003b,0x0000000c,0x0000000d,0x00000000,0x00040017,0x0000000f,0x00000006,0x00000002,
// 	0x00040020,0x00000010,0x00000001,0x0000000f,0x0004003b,0x00000010,0x00000011,0x00000001,
// 	0x00040017,0x00000014,0x00000006,0x00000003,0x00040020,0x00000015,0x00000001,0x00000014,
// 	0x0004003b,0x00000015,0x00000016,0x00000001,0x00050036,0x00000002,0x00000004,0x00000000,
// 	0x00000003,0x000200f8,0x00000005,0x0004003d,0x0000000b,0x0000000e,0x0000000d,0x0004003d,
// 	0x0000000f,0x00000012,0x00000011,0x00050057,0x00000007,0x00000013,0x0000000e,0x00000012,
// 	0x0003003e,0x00000009,0x00000013,0x000100fd,0x00010038
// };
// static const uint32_t shader_22_ubo_vert[] = {
// 	0x07230203,0x00010600,0x0008000b,0x00000031,0x00000000,0x00020011,0x00000001,0x0006000b,
// 	0x00000001,0x4c534c47,0x6474732e,0x3035342e,0x00000000,0x0003000e,0x00000000,0x00000001,
// 	0x000a000f,0x00000000,0x00000004,0x6e69616d,0x00000000,0x0000000d,0x00000013,0x00000021,
// 	0x0000002d,0x0000002f,0x00030003,0x00000002,0x000001c2,0x00040005,0x00000004,0x6e69616d,
// 	0x00000000,0x00060005,0x0000000b,0x505f6c67,0x65567265,0x78657472,0x00000000,0x00060006,
// 	0x0000000b,0x00000000,0x505f6c67,0x7469736f,0x006e6f69,0x00070006,0x0000000b,0x00000001,
// 	0x505f6c67,0x746e696f,0x657a6953,0x00000000,0x00070006,0x0000000b,0x00000002,0x435f6c67,
// 	0x4470696c,0x61747369,0x0065636e,0x00070006,0x0000000b,0x00000003,0x435f6c67,0x446c6c75,
// 	0x61747369,0x0065636e,0x00030005,0x0000000d,0x00000000,0x00070005,0x00000011,0x66696e55,
// 	0x426d726f,0x65666675,0x6a624f72,0x00746365,0x00050006,0x00000011,0x00000000,0x65646f6d,
// 	0x0000006c,0x00050006,0x00000011,0x00000001,0x77656976,0x00000000,0x00050006,0x00000011,
// 	0x00000002,0x6a6f7270,0x00000000,0x00030005,0x00000013,0x006f6275,0x00050005,0x00000021,
// 	0x6f506e69,0x69746973,0x00006e6f,0x00050005,0x0000002d,0x67617266,0x6f6c6f43,0x00000072,
// 	0x00040005,0x0000002f,0x6f436e69,0x00726f6c,0x00050048,0x0000000b,0x00000000,0x0000000b,
// 	0x00000000,0x00050048,0x0000000b,0x00000001,0x0000000b,0x00000001,0x00050048,0x0000000b,
// 	0x00000002,0x0000000b,0x00000003,0x00050048,0x0000000b,0x00000003,0x0000000b,0x00000004,
// 	0x00030047,0x0000000b,0x00000002,0x00040048,0x00000011,0x00000000,0x00000005,0x00050048,
// 	0x00000011,0x00000000,0x00000023,0x00000000,0x00050048,0x00000011,0x00000000,0x00000007,
// 	0x00000010,0x00040048,0x00000011,0x00000001,0x00000005,0x00050048,0x00000011,0x00000001,
// 	0x00000023,0x00000040,0x00050048,0x00000011,0x00000001,0x00000007,0x00000010,0x00040048,
// 	0x00000011,0x00000002,0x00000005,0x00050048,0x00000011,0x00000002,0x00000023,0x00000080,
// 	0x00050048,0x00000011,0x00000002,0x00000007,0x00000010,0x00030047,0x00000011,0x00000002,
// 	0x00040047,0x00000013,0x00000022,0x00000000,0x00040047,0x00000013,0x00000021,0x00000000,
// 	0x00040047,0x00000021,0x0000001e,0x00000000,0x00040047,0x0000002d,0x0000001e,0x00000000,
// 	0x00040047,0x0000002f,0x0000001e,0x00000001,0x00020013,0x00000002,0x00030021,0x00000003,
// 	0x00000002,0x00030016,0x00000006,0x00000020,0x00040017,0x00000007,0x00000006,0x00000004,
// 	0x00040015,0x00000008,0x00000020,0x00000000,0x0004002b,0x00000008,0x00000009,0x00000001,
// 	0x0004001c,0x0000000a,0x00000006,0x00000009,0x0006001e,0x0000000b,0x00000007,0x00000006,
// 	0x0000000a,0x0000000a,0x00040020,0x0000000c,0x00000003,0x0000000b,0x0004003b,0x0000000c,
// 	0x0000000d,0x00000003,0x00040015,0x0000000e,0x00000020,0x00000001,0x0004002b,0x0000000e,
// 	0x0000000f,0x00000000,0x00040018,0x00000010,0x00000007,0x00000004,0x0005001e,0x00000011,
// 	0x00000010,0x00000010,0x00000010,0x00040020,0x00000012,0x00000002,0x00000011,0x0004003b,
// 	0x00000012,0x00000013,0x00000002,0x0004002b,0x0000000e,0x00000014,0x00000002,0x00040020,
// 	0x00000015,0x00000002,0x00000010,0x0004002b,0x0000000e,0x00000018,0x00000001,0x00040017,
// 	0x0000001f,0x00000006,0x00000002,0x00040020,0x00000020,0x00000001,0x0000001f,0x0004003b,
// 	0x00000020,0x00000021,0x00000001,0x0004002b,0x00000006,0x00000023,0x00000000,0x0004002b,
// 	0x00000006,0x00000024,0x3f800000,0x00040020,0x00000029,0x00000003,0x00000007,0x00040017,
// 	0x0000002b,0x00000006,0x00000003,0x00040020,0x0000002c,0x00000003,0x0000002b,0x0004003b,
// 	0x0000002c,0x0000002d,0x00000003,0x00040020,0x0000002e,0x00000001,0x0000002b,0x0004003b,
// 	0x0000002e,0x0000002f,0x00000001,0x00050036,0x00000002,0x00000004,0x00000000,0x00000003,
// 	0x000200f8,0x00000005,0x00050041,0x00000015,0x00000016,0x00000013,0x00000014,0x0004003d,
// 	0x00000010,0x00000017,0x00000016,0x00050041,0x00000015,0x00000019,0x00000013,0x00000018,
// 	0x0004003d,0x00000010,0x0000001a,0x00000019,0x00050092,0x00000010,0x0000001b,0x00000017,
// 	0x0000001a,0x00050041,0x00000015,0x0000001c,0x00000013,0x0000000f,0x0004003d,0x00000010,
// 	0x0000001d,0x0000001c,0x00050092,0x00000010,0x0000001e,0x0000001b,0x0000001d,0x0004003d,
// 	0x0000001f,0x00000022,0x00000021,0x00050051,0x00000006,0x00000025,0x00000022,0x00000000,
// 	0x00050051,0x00000006,0x00000026,0x00000022,0x00000001,0x00070050,0x00000007,0x00000027,
// 	0x00000025,0x00000026,0x00000023,0x00000024,0x00050091,0x00000007,0x00000028,0x0000001e,
// 	0x00000027,0x00050041,0x00000029,0x0000002a,0x0000000d,0x0000000f,0x0003003e,0x0000002a,
// 	0x00000028,0x0004003d,0x0000002b,0x00000030,0x0000002f,0x0003003e,0x0000002d,0x00000030,
// 	0x000100fd,0x00010038
// };
// static const uint32_t shader_22_ubo_frag[] = {
// 	0x07230203,0x00010600,0x0008000b,0x00000013,0x00000000,0x00020011,0x00000001,0x0006000b,
// 	0x00000001,0x4c534c47,0x6474732e,0x3035342e,0x00000000,0x0003000e,0x00000000,0x00000001,
// 	0x0007000f,0x00000004,0x00000004,0x6e69616d,0x00000000,0x00000009,0x0000000c,0x00030010,
// 	0x00000004,0x00000007,0x00030003,0x00000002,0x000001c2,0x00040005,0x00000004,0x6e69616d,
// 	0x00000000,0x00050005,0x00000009,0x4374756f,0x726f6c6f,0x00000000,0x00050005,0x0000000c,
// 	0x67617266,0x6f6c6f43,0x00000072,0x00040047,0x00000009,0x0000001e,0x00000000,0x00040047,
// 	0x0000000c,0x0000001e,0x00000000,0x00020013,0x00000002,0x00030021,0x00000003,0x00000002,
// 	0x00030016,0x00000006,0x00000020,0x00040017,0x00000007,0x00000006,0x00000004,0x00040020,
// 	0x00000008,0x00000003,0x00000007,0x0004003b,0x00000008,0x00000009,0x00000003,0x00040017,
// 	0x0000000a,0x00000006,0x00000003,0x00040020,0x0000000b,0x00000001,0x0000000a,0x0004003b,
// 	0x0000000b,0x0000000c,0x00000001,0x0004002b,0x00000006,0x0000000e,0x3f800000,0x00050036,
// 	0x00000002,0x00000004,0x00000000,0x00000003,0x000200f8,0x00000005,0x0004003d,0x0000000a,
// 	0x0000000d,0x0000000c,0x00050051,0x00000006,0x0000000f,0x0000000d,0x00000000,0x00050051,
// 	0x00000006,0x00000010,0x0000000d,0x00000001,0x00050051,0x00000006,0x00000011,0x0000000d,
// 	0x00000002,0x00070050,0x00000007,0x00000012,0x0000000f,0x00000010,0x00000011,0x0000000e,
// 	0x0003003e,0x00000009,0x00000012,0x000100fd,0x00010038
// };
// static const FUShaderCode sd32VertCode = {
//     .size = sizeof(shader_32_texture_vert),
//     .code = shader_32_texture_vert,
// };
// static const FUShaderCode sd32FragCode = {
//     .size = sizeof(shader_32_texture_frag),
//     .code = shader_32_texture_frag,
// };
// static const FUShaderCode sd22VertCode = {
//     .size = sizeof(shader_22_ubo_vert),
//     .code = shader_22_ubo_vert,
// };
// static const FUShaderCode sd22FragCode = {
//     .size = sizeof(shader_22_ubo_frag),
//     .code = shader_22_ubo_frag,
// };
// // clang-format on
// // FUShaderGroup
// }
// void fu_shader_library_destroy() { }
// FUShader* fu_shader_library_add()
// {
//     return NULL;
// }
// FUShader* fu_shader_library_get(uint32_t index)
// {
//     return NULL;
// }

#endif
#ifdef FU_RENDERER_TYPE_VK
#include "core/logger.h"
#include "core/memory.h"

#include "misc.inner.h"

void fu_shader_free(FUShader* shader)
{
    if (!shader)
        return;
    fu_shader_t* sd = (fu_shader_t*)shader;
    fu_free(sd->attributes);
    fu_free(sd->code);
    fu_free(sd);
}

FUShader* fu_shader_new(const FUShaderCode* source, FUShaderStage stage)
{
    fu_return_val_if_fail(source && source->code && source->size, NULL);
    fu_shader_t* sd = fu_malloc0(sizeof(fu_shader_t));
    sd->code = fu_memdup(source->code, source->size);
    sd->codeSize = source->size;
    sd->stage = stage;
    return (FUShader*)sd;
}

void fu_shader_set_attributes(FUShader* shader, const uint32_t cnt, ...)
{
    const uint32_t defAttrSizes[] = {
        [VK_FORMAT_R32_SINT] = sizeof(int32_t),
        [VK_FORMAT_R32G32_SINT] = sizeof(int32_t[2]),
        [VK_FORMAT_R32G32B32_SINT] = sizeof(int32_t[3]),
        [VK_FORMAT_R32G32B32A32_SINT] = sizeof(int32_t[4]),
        [VK_FORMAT_R32_UINT] = sizeof(uint32_t),
        [VK_FORMAT_R32G32_UINT] = sizeof(uint32_t[2]),
        [VK_FORMAT_R32G32B32_UINT] = sizeof(uint32_t[3]),
        [VK_FORMAT_R32G32B32A32_UINT] = sizeof(uint32_t[4]),
        [VK_FORMAT_R64_SINT] = sizeof(int64_t),
        [VK_FORMAT_R64G64_SINT] = sizeof(int64_t[2]),
        [VK_FORMAT_R64G64B64_SINT] = sizeof(int64_t[3]),
        [VK_FORMAT_R64G64B64A64_SINT] = sizeof(int64_t[4]),
        [VK_FORMAT_R64_UINT] = sizeof(uint64_t),
        [VK_FORMAT_R64G64_UINT] = sizeof(uint64_t[2]),
        [VK_FORMAT_R64G64B64_UINT] = sizeof(uint64_t[3]),
        [VK_FORMAT_R64G64B64A64_UINT] = sizeof(uint64_t[4]),
        [VK_FORMAT_R32_SFLOAT] = sizeof(float),
        [VK_FORMAT_R32G32_SFLOAT] = sizeof(float[2]),
        [VK_FORMAT_R32G32B32_SFLOAT] = sizeof(float[3]),
        [VK_FORMAT_R32G32B32A32_SFLOAT] = sizeof(float[4]),
        [VK_FORMAT_R64_SFLOAT] = sizeof(double),
        [VK_FORMAT_R64G64_SFLOAT] = sizeof(double[2]),
        [VK_FORMAT_R64G64B64_SFLOAT] = sizeof(double[3]),
        [VK_FORMAT_R64G64B64A64_SFLOAT] = sizeof(double[4])
    };
    fu_return_if_fail(shader && cnt);
    fu_shader_t* sd = (fu_shader_t*)shader;
    fu_return_if_true(VK_SHADER_STAGE_VERTEX_BIT != sd->stage);

    va_list ap;
    va_start(ap, cnt);

    sd->attributeCount = cnt;
    sd->attributes = fu_malloc0(sizeof(VkVertexInputAttributeDescription) * cnt);
    for (uint32_t i = 0; i < cnt; i++) {
        sd->attributes[i].location = i;
        sd->attributes[i].format = va_arg(ap, VkFormat);
        sd->attributes[i].offset = sd->stride;
        sd->stride += defAttrSizes[sd->attributes[i].format];
    }
    va_end(ap);
}

/**
 * @brief 添加统一描述符
 */
int fu_shader_add_uniform_descriptor(FUShader* shader, const uint32_t size, const uint32_t count, VkBufferUsageFlags usage)
{
    fu_return_val_if_fail(shader && count, -1);
    fu_shader_t* sd = (fu_shader_t*)shader;
    sd->descriptors = t_descriptor_args_prepare(sd->descriptors, count, VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER, sd->stage);
    sd->usage.buffer = usage;
    return sd->descriptors->binding.binding;
}

int fu_shader_add_sampler_descriptor(FUShader* shader, const uint32_t size, const uint32_t count, VkImageUsageFlags usage)
{
    fu_return_val_if_fail(shader && count, -1);
    fu_shader_t* sd = (fu_shader_t*)shader;
    sd->descriptors = t_descriptor_args_prepare(sd->descriptors, count, VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER, sd->stage);
    sd->usage.image = usage;
    return sd->descriptors->binding.binding;
}

#endif